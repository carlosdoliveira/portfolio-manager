# ğŸ”„ Fluxo de ConsolidaÃ§Ã£o de Mercados

## VisÃ£o Geral do Sistema

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     IMPORTAÃ‡ÃƒO / ENTRADA                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  ğŸ“„ RelatÃ³rio B3 ou OperaÃ§Ã£o Manual                              â”‚
â”‚     â”œâ”€ Data: 01/01/2026                                          â”‚
â”‚     â”œâ”€ Ticker: PETR4                                             â”‚
â”‚     â”œâ”€ Mercado: MERCADO A VISTA                                  â”‚
â”‚     â”œâ”€ Quantidade: 100                                           â”‚
â”‚     â””â”€ Valor: R$ 3.000,00                                        â”‚
â”‚                                                                   â”‚
â”‚  ğŸ“„ RelatÃ³rio B3 ou OperaÃ§Ã£o Manual                              â”‚
â”‚     â”œâ”€ Data: 05/01/2026                                          â”‚
â”‚     â”œâ”€ Ticker: PETR4                                             â”‚
â”‚     â”œâ”€ Mercado: MERCADO FRACIONARIO                              â”‚
â”‚     â”œâ”€ Quantidade: 5                                             â”‚
â”‚     â””â”€ Valor: R$ 155,00                                          â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ARMAZENAMENTO (SQLite)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  ğŸ“Š Tabela: operations                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ id | asset_id | date       | market             | qty | ...â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”¤ â”‚
â”‚  â”‚ 1  â”‚ 42       â”‚ 2026-01-01 â”‚ MERCADO A VISTA    â”‚ 100 â”‚...â”‚ â”‚
â”‚  â”‚ 2  â”‚ 42       â”‚ 2026-01-05 â”‚ MERCADO FRACIONARIOâ”‚  5  â”‚...â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”˜ â”‚
â”‚                                                                   â”‚
â”‚  âš ï¸  IMPORTANTE: OperaÃ§Ãµes sÃ£o armazenadas EXATAMENTE como       â”‚
â”‚      ocorreram, preservando o mercado original (event sourcing) â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               CONSOLIDAÃ‡ÃƒO (Query SQL Agregada)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  SELECT                                                           â”‚
â”‚    ticker,                                                        â”‚
â”‚    SUM(CASE WHEN movement_type = 'COMPRA'                        â”‚
â”‚             THEN quantity ELSE 0 END) as total_bought,           â”‚
â”‚  FROM assets a                                                    â”‚
â”‚  LEFT JOIN operations o ON a.id = o.asset_id                     â”‚
â”‚  GROUP BY a.id                                                    â”‚
â”‚                                                                   â”‚
â”‚  ğŸ”‘ SEM filtro por 'market' â†’ ConsolidaÃ§Ã£o automÃ¡tica!           â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  VISUALIZAÃ‡ÃƒO (Frontend)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  ğŸ¯ CARTEIRA (/portfolio)                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Ticker â”‚ PosiÃ§Ã£o Atual â”‚ Total Investido                   â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ PETR4  â”‚ 105 aÃ§Ãµes     â”‚ R$ 3.155,00                       â”‚ â”‚
â”‚  â”‚        â”‚ (consolidada) â”‚ (todos os mercados)               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                   â”‚
â”‚  ğŸ“Š DETALHES DO ATIVO (/portfolio/42)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ“Š Resumo por Mercado                                       â”‚ â”‚
â”‚  â”‚                                                              â”‚ â”‚
â”‚  â”‚ â„¹ï¸  A posiÃ§Ã£o atual Ã© consolidada automaticamente           â”‚ â”‚
â”‚  â”‚                                                              â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚ â”‚ MERCADO A VISTA     â”‚ Comprado â”‚ Vendido â”‚ OperaÃ§Ãµes â”‚  â”‚ â”‚
â”‚  â”‚ â”‚                     â”‚ 100      â”‚ 0       â”‚ 1         â”‚  â”‚ â”‚
â”‚  â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚ â”‚
â”‚  â”‚ â”‚ MERCADO FRACIONARIO â”‚ Comprado â”‚ Vendido â”‚ OperaÃ§Ãµes â”‚  â”‚ â”‚
â”‚  â”‚ â”‚                     â”‚ 5        â”‚ 0       â”‚ 1         â”‚  â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚                                                              â”‚ â”‚
â”‚  â”‚ ğŸ“‹ Tabela Completa de OperaÃ§Ãµes                             â”‚ â”‚
â”‚  â”‚ (Mostra cada operaÃ§Ã£o com seu mercado original)             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ComparaÃ§Ã£o: Antes vs Depois

### âŒ ANTES (Problema Potencial)

```
UsuÃ¡rio poderia pensar que operaÃ§Ãµes em mercados diferentes 
criam posiÃ§Ãµes separadas:

PETR4 (Mercado Ã  Vista)      â†’ 100 aÃ§Ãµes
PETR4 (Mercado FracionÃ¡rio)  â†’   5 aÃ§Ãµes
                              â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                                 ??? Total?
```

### âœ… DEPOIS (SoluÃ§Ã£o Clara)

```
Sistema mostra explicitamente que hÃ¡ consolidaÃ§Ã£o:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PosiÃ§Ã£o Atual: 105 aÃ§Ãµes           â”‚
â”‚ Consolidada (todos os mercados)    â”‚ â† Nota explicativa
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Com drill-down disponÃ­vel:
  â””â”€ Resumo por Mercado (informativo)
      â”œâ”€ MERCADO A VISTA: 100 aÃ§Ãµes
      â””â”€ MERCADO FRACIONARIO: 5 aÃ§Ãµes
```

---

## BenefÃ­cios da Abordagem

| Aspecto | Antes | Depois |
|---------|-------|--------|
| **Clareza** | ImplÃ­cito | ExplÃ­cito com nota visual |
| **TransparÃªncia** | Apenas total | Total + breakdown por mercado |
| **Auditoria** | âœ… Preservada | âœ… Preservada + visÃ­vel |
| **EducaÃ§Ã£o** | UsuÃ¡rio precisa deduzir | Sistema explica |
| **UX** | BÃ¡sica | Profissional e informativa |

---

## Exemplos de Uso

### Caso 1: Investidor Iniciante
```
ğŸ‘¤ "Comprei 100 PETR4 no mercado Ã  vista e 5 no fracionÃ¡rio. 
    Quantas aÃ§Ãµes eu tenho?"

ğŸ’¡ Sistema mostra:
   - Card: "PosiÃ§Ã£o Atual: 105 aÃ§Ãµes (consolidada)"
   - Resumo por mercado explica a origem
```

### Caso 2: Investidor Experiente
```
ğŸ‘¤ "Quero saber se minhas compras no fracionÃ¡rio tÃªm preÃ§o 
    mÃ©dio diferente do mercado Ã  vista"

ğŸ’¡ Sistema permite:
   - Ver posiÃ§Ã£o consolidada
   - Drill-down no resumo por mercado
   - AnÃ¡lise detalhada na tabela de operaÃ§Ãµes
```

### Caso 3: Auditoria
```
ğŸ‘¤ "Preciso verificar se todas as minhas operaÃ§Ãµes da B3 
    estÃ£o corretas"

ğŸ’¡ Sistema oferece:
   - Tabela completa com coluna "Mercado"
   - Cada operaÃ§Ã£o preservada como importada
   - Totais conferem com posiÃ§Ã£o consolidada
```

---

## Arquitetura Event-Based

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EVENTO 1 (ImutÃ¡vel)                 â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”‚
â”‚ Date:   2026-01-01                  â”‚
â”‚ Type:   COMPRA                      â”‚
â”‚ Market: MERCADO A VISTA             â”‚
â”‚ Qty:    100                         â”‚
â”‚ Price:  R$ 30.00                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              +
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EVENTO 2 (ImutÃ¡vel)                 â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”‚
â”‚ Date:   2026-01-05                  â”‚
â”‚ Type:   COMPRA                      â”‚
â”‚ Market: MERCADO FRACIONARIO         â”‚
â”‚ Qty:    5                           â”‚
â”‚ Price:  R$ 31.00                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â•‘
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ESTADO DERIVADO (Calculado)         â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€             â”‚
â”‚ PosiÃ§Ã£o:     105 aÃ§Ãµes              â”‚
â”‚ Investido:   R$ 3.155,00            â”‚
â”‚ PreÃ§o MÃ©dio: R$ 30.05               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**PrincÃ­pio:** 
- Eventos sÃ£o a fonte da verdade (immutable)
- Estado Ã© derivado em runtime (calculated)
- ConsolidaÃ§Ã£o Ã© parte da derivaÃ§Ã£o (transparent)

---

## ConclusÃ£o

A consolidaÃ§Ã£o de mercados Ã© uma **feature, nÃ£o um bug**. 

O sistema foi projetado para:
1. âœ… Armazenar a realidade (operaÃ§Ãµes com mercado)
2. âœ… Calcular o estado atual (posiÃ§Ã£o consolidada)
3. âœ… Mostrar ambos de forma clara (transparÃªncia)

Esta abordagem respeita os princÃ­pios do projeto e oferece 
a melhor experiÃªncia para o usuÃ¡rio.
